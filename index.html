<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>PathTracker - ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #4361ee;
            --primary-dark: #3651d4;
            --secondary: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #ef233c;
            --dark: #1a1a2e;
            --darker: #16162a;
            --light: #edf2f4;
            --glass: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: var(--dark);
            color: var(--light);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: var(--darker);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass);
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 700;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--glass);
            border-radius: 10px;
            color: var(--light);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-btn:hover {
            background: var(--primary);
        }
        
        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Stats Overlay - Left Side */
        .stats-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        
        .stat-card {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px 12px;
            min-width: 90px;
            border: 1px solid var(--glass);
        }
        
        .stat-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .stat-value.distance { color: var(--success); }
        .stat-value.time { color: var(--warning); }
        .stat-value.speed { color: var(--secondary); }
        
        /* Compass */
        .compass-container {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
        }
        
        .compass {
            width: 60px;
            height: 60px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            border: 2px solid var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .compass-arrow {
            font-size: 28px;
            transition: transform 0.3s ease;
        }
        
        .compass-n {
            position: absolute;
            top: 5px;
            font-size: 10px;
            font-weight: bold;
            color: var(--danger);
        }
        
        /* Map Toggle Button */
        .map-toggle {
            position: absolute;
            top: 85px;
            right: 15px;
            z-index: 1000;
        }
        
        .map-toggle-btn {
            width: 60px;
            height: 40px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid var(--glass);
            border-radius: 10px;
            color: var(--light);
            font-size: 11px;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .map-toggle-btn:hover {
            background: var(--primary);
        }
        
        /* Direction Arrow Marker */
        .direction-marker {
            width: 40px !important;
            height: 40px !important;
            margin-left: -20px !important;
            margin-top: -20px !important;
        }
        
        .direction-arrow {
            width: 40px;
            height: 40px;
            position: relative;
        }
        
        .direction-arrow svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            transition: transform 0.3s ease;
        }
        
        /* Bottom Controls */
        .bottom-controls {
            background: var(--darker);
            padding: 20px;
            border-top: 1px solid var(--glass);
            z-index: 1000;
        }
        
        .main-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }
        
        .btn-start {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #00c853, #00e676);
            color: white;
            font-size: 28px;
            box-shadow: 0 8px 30px rgba(0, 200, 83, 0.4);
        }
        
        .btn-start:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(0, 200, 83, 0.5);
        }
        
        .btn-stop {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--danger), #ff4d6d);
            color: white;
            font-size: 28px;
            box-shadow: 0 8px 30px rgba(239, 35, 60, 0.4);
        }
        
        .btn-stop:hover {
            transform: scale(1.05);
        }
        
        .btn-secondary {
            width: 56px;
            height: 56px;
            background: var(--glass);
            color: var(--light);
            font-size: 20px;
            border: 1px solid var(--glass);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-secondary.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #888;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888;
        }
        
        .status-dot.active {
            background: #00e676;
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.navigating {
            background: var(--success);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: var(--darker);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--glass);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--glass);
            border-radius: 50%;
            color: var(--light);
            font-size: 18px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .setting-group {
            margin-bottom: 25px;
        }
        
        .setting-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            display: block;
        }
        
        .interval-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .interval-btn {
            padding: 12px;
            border: 2px solid var(--glass);
            background: transparent;
            border-radius: 10px;
            color: var(--light);
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .interval-btn:hover {
            border-color: var(--primary);
        }
        
        .interval-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        /* Navigation Modal */
        .nav-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .nav-option {
            padding: 20px;
            border: 2px solid var(--glass);
            background: transparent;
            border-radius: 15px;
            color: var(--light);
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            text-align: right;
        }
        
        .nav-option:hover {
            border-color: var(--primary);
            background: var(--glass);
        }
        
        .nav-option-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-option-desc {
            font-size: 13px;
            color: #888;
        }
        
        /* Saved Tracks */
        .tracks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .track-item {
            padding: 15px;
            background: var(--glass);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .track-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .track-info span {
            font-size: 12px;
            color: #888;
        }
        
        .track-actions {
            display: flex;
            gap: 8px;
        }
        
        .track-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .track-btn.load {
            background: var(--primary);
            color: white;
        }
        
        .track-btn.delete {
            background: var(--danger);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        /* GPS Accuracy Indicator */
        .gps-accuracy {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--glass);
        }
        
        .accuracy-icon {
            font-size: 16px;
        }
        
        .accuracy-good { color: #00e676; }
        .accuracy-medium { color: #ffc107; }
        .accuracy-poor { color: #ff5252; }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--light);
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--glass);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* Hide Leaflet attribution on mobile */
        .leaflet-control-attribution {
            display: none;
        }
        
        /* Custom marker styles */
        .start-marker {
            background: #00e676;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px !important;
            height: 20px !important;
            margin-left: -10px !important;
            margin-top: -10px !important;
            box-shadow: 0 2px 10px rgba(0, 230, 118, 0.5);
        }
        
        .end-marker {
            background: var(--danger);
            border: 3px solid white;
            border-radius: 50%;
            width: 20px !important;
            height: 20px !important;
            margin-left: -10px !important;
            margin-top: -10px !important;
            box-shadow: 0 2px 10px rgba(239, 35, 60, 0.5);
        }
        
        .current-marker {
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            width: 24px !important;
            height: 24px !important;
            margin-left: -12px !important;
            margin-top: -12px !important;
            box-shadow: 0 2px 15px rgba(67, 97, 238, 0.6);
            animation: currentPulse 2s infinite;
        }
        
        @keyframes currentPulse {
            0%, 100% { box-shadow: 0 2px 15px rgba(67, 97, 238, 0.6); }
            50% { box-shadow: 0 2px 25px rgba(67, 97, 238, 0.9); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ“</div>
            <span class="logo-text">PathTracker</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="showTracksModal()" title="Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©">ğŸ“</button>
            <button class="icon-btn" onclick="showSettingsModal()" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
        </div>
    </header>
    
    <!-- Map -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- Stats Overlay - Left Side -->
        <div class="stats-overlay">
            <div class="stat-card">
                <div class="stat-label">Ø§Ù„Ø³Ø±Ø¹Ø©</div>
                <div class="stat-value speed" id="speed">0 ÙƒÙ…/Ø³</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø§Ù„Ù…Ø³Ø§ÙØ©</div>
                <div class="stat-value distance" id="distance">0.00 ÙƒÙ…</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø§Ù„ÙˆÙ‚Øª</div>
                <div class="stat-value time" id="duration">00:00</div>
            </div>
        </div>
        
        <!-- Compass -->
        <div class="compass-container">
            <div class="compass">
                <span class="compass-n">N</span>
                <span class="compass-arrow" id="compassArrow">â¬†ï¸</span>
            </div>
        </div>
        
        <!-- Map Toggle -->
        <div class="map-toggle">
            <button class="map-toggle-btn" id="mapToggleBtn" onclick="toggleMapType()">
                ğŸ›°ï¸<br>Ù‚Ù…Ø±
            </button>
        </div>
        
        <!-- GPS Accuracy -->
        <div class="gps-accuracy">
            <span class="accuracy-icon" id="accuracyIcon">ğŸ“¡</span>
            <span id="accuracyText">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
        </div>
    </div>
    
    <!-- Bottom Controls -->
    <div class="bottom-controls">
        <div class="main-controls">
            <button class="control-btn btn-secondary" id="centerBtn" onclick="centerMap()" title="ØªÙˆØ³ÙŠØ· Ø§Ù„Ø®Ø±ÙŠØ·Ø©">ğŸ¯</button>
            <button class="control-btn btn-start" id="mainBtn" onclick="toggleTracking()">â–¶</button>
            <button class="control-btn btn-secondary" id="followBtn" onclick="toggleFollow()" title="ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹">ğŸ‘</button>
        </div>
        <div class="status-bar">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</span>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                <button class="modal-close" onclick="closeModal('settingsModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">ÙØªØ±Ø© Ø§Ù„ØªØªØ¨Ø¹ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)</label>
                    <div class="interval-options">
                        <button class="interval-btn" data-interval="1">1</button>
                        <button class="interval-btn" data-interval="2">2</button>
                        <button class="interval-btn active" data-interval="5">5</button>
                        <button class="interval-btn" data-interval="10">10</button>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                    <div class="interval-options">
                        <button class="interval-btn map-type active" data-map="street">Ø¹Ø§Ø¯ÙŠ</button>
                        <button class="interval-btn map-type" data-map="satellite">Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ</button>
                        <button class="interval-btn map-type" data-map="terrain">ØªØ¶Ø§Ø±ÙŠØ³</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Modal -->
    <div class="modal-overlay" id="navModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ğŸ§­ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±</span>
                <button class="modal-close" onclick="closeModal('navModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="nav-options">
                    <button class="nav-option" onclick="startNavigation('same')">
                        <div class="nav-option-title">â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±</div>
                        <div class="nav-option-desc">Ø§ØªØ¨Ø¹ Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø°ÙŠ Ø³Ù„ÙƒØªÙ‡ Ø¨Ø§Ù„Ø¶Ø¨Ø·</div>
                    </button>
                    <button class="nav-option" onclick="startNavigation('free')">
                        <div class="nav-option-title">ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± ÙÙ‚Ø·</div>
                        <div class="nav-option-desc">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØªÙ†Ù‚Ù„ Ø¨Ø­Ø±ÙŠØ©</div>
                    </button>
                    <button class="nav-option" onclick="saveTrack()">
                        <div class="nav-option-title">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±</div>
                        <div class="nav-option-desc">Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹</div>
                    </button>
                    <button class="nav-option" onclick="clearTrack()">
                        <div class="nav-option-title">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙˆØ¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯</div>
                        <div class="nav-option-desc">Ø§Ù…Ø³Ø­ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯</div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Saved Tracks Modal -->
    <div class="modal-overlay" id="tracksModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span>
                <button class="modal-close" onclick="closeModal('tracksModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="tracks-list" id="tracksList">
                    <!-- Tracks will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ==================== App State ====================
        const state = {
            isTracking: false,
            isNavigating: false,
            followMode: true,
            trackingInterval: 5000, // ms
            currentPosition: null,
            currentHeading: 0,
            compassHeading: 0,
            trackPoints: [],
            navigationPoints: [],
            startTime: null,
            totalDistance: 0,
            watchId: null,
            intervalId: null,
            isSatellite: false
        };
        
        // ==================== Map Setup ====================
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([24.7136, 46.6753], 13); // Default to Riyadh
        
        // Map layers
        const mapLayers = {
            street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17
            })
        };
        
        mapLayers.street.addTo(map);
        
        // Path layers
        let trackPath = null;
        let navPath = null;
        let startMarker = null;
        let endMarker = null;
        let currentMarker = null;
        
        // ==================== Geolocation ====================
        function initGeolocation() {
            if (!navigator.geolocation) {
                showToast('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
                return;
            }
            
            // Watch position for real-time updates
            state.watchId = navigator.geolocation.watchPosition(
                onPositionUpdate,
                onPositionError,
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        function onPositionUpdate(position) {
            const { latitude, longitude, accuracy, speed, heading } = position.coords;
            state.currentPosition = { lat: latitude, lng: longitude, accuracy, speed };
            
            // Update heading from GPS (when moving)
            if (heading !== null && !isNaN(heading) && speed > 1) {
                state.currentHeading = heading;
            }
            
            // Update accuracy indicator
            updateAccuracyIndicator(accuracy);
            
            // Update current marker
            updateCurrentMarker(latitude, longitude);
            
            // Update speed display
            if (speed !== null) {
                const speedKmh = Math.round(speed * 3.6);
                document.getElementById('speed').textContent = `${speedKmh} ÙƒÙ…/Ø³`;
            }
            
            // Center map if follow mode
            if (state.followMode && !state.isTracking) {
                map.setView([latitude, longitude], map.getZoom());
            }
        }
        
        function onPositionError(error) {
            console.error('Geolocation error:', error);
            let msg = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
            if (error.code === 1) msg = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹';
            if (error.code === 2) msg = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­';
            if (error.code === 3) msg = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
            showToast(msg);
            updateAccuracyIndicator(-1);
        }
        
        function updateAccuracyIndicator(accuracy) {
            const icon = document.getElementById('accuracyIcon');
            const text = document.getElementById('accuracyText');
            
            if (accuracy < 0) {
                icon.className = 'accuracy-icon accuracy-poor';
                text.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ GPS';
            } else if (accuracy <= 10) {
                icon.className = 'accuracy-icon accuracy-good';
                text.textContent = `Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø© (${Math.round(accuracy)}Ù…)`;
            } else if (accuracy <= 30) {
                icon.className = 'accuracy-icon accuracy-medium';
                text.textContent = `Ø¯Ù‚Ø© Ø¬ÙŠØ¯Ø© (${Math.round(accuracy)}Ù…)`;
            } else {
                icon.className = 'accuracy-icon accuracy-poor';
                text.textContent = `Ø¯Ù‚Ø© Ø¶Ø¹ÙŠÙØ© (${Math.round(accuracy)}Ù…)`;
            }
        }
        
        function updateCurrentMarker(lat, lng) {
            const arrowHtml = `
                <div class="direction-arrow">
                    <svg viewBox="0 0 24 24" style="transform: rotate(${state.currentHeading}deg)">
                        <path fill="#4361ee" stroke="white" stroke-width="1" d="M12 2L4 20h16L12 2z"/>
                    </svg>
                </div>
            `;
            
            if (!currentMarker) {
                currentMarker = L.marker([lat, lng], {
                    icon: L.divIcon({ 
                        className: 'direction-marker',
                        html: arrowHtml
                    })
                }).addTo(map);
            } else {
                currentMarker.setLatLng([lat, lng]);
                currentMarker.setIcon(L.divIcon({ 
                    className: 'direction-marker',
                    html: arrowHtml
                }));
            }
        }
        
        // ==================== Tracking ====================
        function toggleTracking() {
            if (state.isNavigating) {
                stopNavigation();
                return;
            }
            
            if (state.isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        }
        
        function startTracking() {
            if (!state.currentPosition) {
                showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
                return;
            }
            
            state.isTracking = true;
            state.trackPoints = [];
            state.totalDistance = 0;
            state.startTime = Date.now();
            
            // Add first point
            addTrackPoint();
            
            // Start interval
            state.intervalId = setInterval(addTrackPoint, state.trackingInterval);
            
            // Update UI
            updateUI();
            showToast('Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        }
        
        function stopTracking() {
            state.isTracking = false;
            
            if (state.intervalId) {
                clearInterval(state.intervalId);
                state.intervalId = null;
            }
            
            // Add end marker
            if (state.trackPoints.length > 0) {
                const lastPoint = state.trackPoints[state.trackPoints.length - 1];
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.marker([lastPoint.lat, lastPoint.lng], {
                    icon: L.divIcon({ className: 'end-marker' })
                }).addTo(map);
            }
            
            updateUI();
            
            // Show navigation options
            if (state.trackPoints.length > 1) {
                showModal('navModal');
            }
        }
        
        function addTrackPoint() {
            if (!state.currentPosition) return;
            
            const point = {
                lat: state.currentPosition.lat,
                lng: state.currentPosition.lng,
                timestamp: Date.now()
            };
            
            // Calculate distance from last point
            if (state.trackPoints.length > 0) {
                const lastPoint = state.trackPoints[state.trackPoints.length - 1];
                const distance = calculateDistance(
                    lastPoint.lat, lastPoint.lng,
                    point.lat, point.lng
                );
                state.totalDistance += distance;
            } else {
                // Add start marker
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker([point.lat, point.lng], {
                    icon: L.divIcon({ className: 'start-marker' })
                }).addTo(map);
            }
            
            state.trackPoints.push(point);
            
            // Update path
            drawTrackPath();
            
            // Update stats
            updateStats();
            
            // Pan map
            if (state.followMode) {
                map.panTo([point.lat, point.lng]);
            }
        }
        
        function drawTrackPath() {
            const latlngs = state.trackPoints.map(p => [p.lat, p.lng]);
            
            if (trackPath) {
                trackPath.setLatLngs(latlngs);
            } else {
                trackPath = L.polyline(latlngs, {
                    color: '#4361ee',
                    weight: 5,
                    opacity: 0.8,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(map);
            }
        }
        
        function updateStats() {
            // Distance
            const distanceKm = (state.totalDistance / 1000).toFixed(2);
            document.getElementById('distance').textContent = `${distanceKm} ÙƒÙ…`;
            
            // Duration
            if (state.startTime) {
                const elapsed = Date.now() - state.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('duration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // ==================== Navigation ====================
        function startNavigation(mode) {
            closeModal('navModal');
            
            if (mode === 'same') {
                state.isNavigating = true;
                state.navigationPoints = [...state.trackPoints].reverse();
                
                // Draw navigation path
                if (navPath) map.removeLayer(navPath);
                navPath = L.polyline(
                    state.navigationPoints.map(p => [p.lat, p.lng]),
                    {
                        color: '#4cc9f0',
                        weight: 6,
                        opacity: 0.8,
                        dashArray: '10, 10'
                    }
                ).addTo(map);
                
                // Fit bounds
                map.fitBounds(navPath.getBounds(), { padding: [50, 50] });
                
                updateUI();
                showToast('ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ù…ÙØ¹Ù„');
            } else {
                // Just show the path
                if (trackPath) {
                    map.fitBounds(trackPath.getBounds(), { padding: [50, 50] });
                }
            }
        }
        
        function stopNavigation() {
            state.isNavigating = false;
            
            if (navPath) {
                map.removeLayer(navPath);
                navPath = null;
            }
            
            updateUI();
            showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø©');
        }
        
        // ==================== Track Management ====================
        function saveTrack() {
            closeModal('navModal');
            
            const tracks = JSON.parse(localStorage.getItem('savedTracks') || '[]');
            const track = {
                id: Date.now(),
                name: `Ù…Ø³Ø§Ø± ${tracks.length + 1}`,
                date: new Date().toLocaleDateString('ar-SA'),
                distance: (state.totalDistance / 1000).toFixed(2),
                points: state.trackPoints
            };
            
            tracks.push(track);
            localStorage.setItem('savedTracks', JSON.stringify(tracks));
            
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±');
        }
        
        function loadTrack(id) {
            const tracks = JSON.parse(localStorage.getItem('savedTracks') || '[]');
            const track = tracks.find(t => t.id === id);
            
            if (track) {
                clearTrack();
                state.trackPoints = track.points;
                state.totalDistance = parseFloat(track.distance) * 1000;
                
                drawTrackPath();
                
                // Add markers
                if (track.points.length > 0) {
                    const first = track.points[0];
                    const last = track.points[track.points.length - 1];
                    
                    startMarker = L.marker([first.lat, first.lng], {
                        icon: L.divIcon({ className: 'start-marker' })
                    }).addTo(map);
                    
                    endMarker = L.marker([last.lat, last.lng], {
                        icon: L.divIcon({ className: 'end-marker' })
                    }).addTo(map);
                    
                    map.fitBounds(trackPath.getBounds(), { padding: [50, 50] });
                }
                
                closeModal('tracksModal');
                document.getElementById('distance').textContent = `${track.distance} ÙƒÙ…`;
                showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±');
            }
        }
        
        function deleteTrack(id) {
            let tracks = JSON.parse(localStorage.getItem('savedTracks') || '[]');
            tracks = tracks.filter(t => t.id !== id);
            localStorage.setItem('savedTracks', JSON.stringify(tracks));
            loadTracksList();
            showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø±');
        }
        
        function clearTrack() {
            closeModal('navModal');
            
            state.trackPoints = [];
            state.totalDistance = 0;
            state.startTime = null;
            
            if (trackPath) { map.removeLayer(trackPath); trackPath = null; }
            if (navPath) { map.removeLayer(navPath); navPath = null; }
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
            
            document.getElementById('distance').textContent = '0.00 ÙƒÙ…';
            document.getElementById('duration').textContent = '00:00';
            
            updateUI();
        }
        
        // ==================== UI Functions ====================
        function updateUI() {
            const mainBtn = document.getElementById('mainBtn');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const followBtn = document.getElementById('followBtn');
            
            if (state.isNavigating) {
                mainBtn.className = 'control-btn btn-stop';
                mainBtn.innerHTML = 'â¹';
                statusDot.className = 'status-dot navigating';
                statusText.textContent = 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø©';
            } else if (state.isTracking) {
                mainBtn.className = 'control-btn btn-stop';
                mainBtn.innerHTML = 'â¹';
                statusDot.className = 'status-dot active';
                statusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
            } else {
                mainBtn.className = 'control-btn btn-start';
                mainBtn.innerHTML = 'â–¶';
                statusDot.className = 'status-dot';
                statusText.textContent = state.trackPoints.length > 0 ? 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„' : 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡';
            }
            
            followBtn.className = state.followMode ? 
                'control-btn btn-secondary active' : 'control-btn btn-secondary';
        }
        
        function centerMap() {
            if (state.currentPosition) {
                map.setView([state.currentPosition.lat, state.currentPosition.lng], 17);
            }
        }
        
        function toggleFollow() {
            state.followMode = !state.followMode;
            updateUI();
            showToast(state.followMode ? 'ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØ¹Ù„' : 'ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¹Ø·Ù„');
        }
        
        // ==================== Modals ====================
        function showModal(id) {
            document.getElementById(id).classList.add('show');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function showSettingsModal() {
            showModal('settingsModal');
        }
        
        function showTracksModal() {
            loadTracksList();
            showModal('tracksModal');
        }
        
        function loadTracksList() {
            const container = document.getElementById('tracksList');
            const tracks = JSON.parse(localStorage.getItem('savedTracks') || '[]');
            
            if (tracks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tracks.map(track => `
                <div class="track-item">
                    <div class="track-info">
                        <h4>${track.name}</h4>
                        <span>${track.date} â€¢ ${track.distance} ÙƒÙ…</span>
                    </div>
                    <div class="track-actions">
                        <button class="track-btn load" onclick="loadTrack(${track.id})">ğŸ“‚</button>
                        <button class="track-btn delete" onclick="deleteTrack(${track.id})">ğŸ—‘</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ==================== Settings ====================
        document.querySelectorAll('.interval-btn[data-interval]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.interval-btn[data-interval]').forEach(b => 
                    b.classList.remove('active'));
                btn.classList.add('active');
                state.trackingInterval = parseInt(btn.dataset.interval) * 1000;
                showToast(`ÙØªØ±Ø© Ø§Ù„ØªØªØ¨Ø¹: ${btn.dataset.interval} Ø«Ø§Ù†ÙŠØ©`);
            });
        });
        
        document.querySelectorAll('.map-type').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.map-type').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
                mapLayers[btn.dataset.map].addTo(map);
            });
        });
        
        // ==================== Utilities ====================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                     Math.cos(Ï†1) * Math.cos(Ï†2) *
                     Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        // Toggle Map Type
        function toggleMapType() {
            state.isSatellite = !state.isSatellite;
            const btn = document.getElementById('mapToggleBtn');
            
            if (state.isSatellite) {
                map.removeLayer(mapLayers.street);
                mapLayers.satellite.addTo(map);
                btn.innerHTML = 'ğŸ—ºï¸<br>Ø¹Ø§Ø¯ÙŠ';
            } else {
                map.removeLayer(mapLayers.satellite);
                mapLayers.street.addTo(map);
                btn.innerHTML = 'ğŸ›°ï¸<br>Ù‚Ù…Ø±';
            }
        }
        
        // Compass - Device Orientation
        function initCompass() {
            if (window.DeviceOrientationEvent) {
                // iOS 13+ requires permission
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // Will request on first user interaction
                    document.body.addEventListener('click', requestCompassPermission, { once: true });
                } else {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            }
        }
        
        function requestCompassPermission() {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                })
                .catch(console.error);
        }
        
        function handleOrientation(event) {
            let heading = event.alpha; // 0-360
            
            // iOS uses webkitCompassHeading
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            }
            
            if (heading !== null) {
                state.compassHeading = heading;
                const arrow = document.getElementById('compassArrow');
                arrow.style.transform = `rotate(${-heading}deg)`;
            }
        }
        
        // ==================== Init ====================
        initGeolocation();
        initCompass();
        
        // Update duration timer
        setInterval(() => {
            if (state.isTracking) updateStats();
        }, 1000);
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
